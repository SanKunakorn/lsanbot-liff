<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
  <title>San BOT</title>
  <style>
  </style>
  <link rel="stylesheet" href="styles.css">
  <script src="script.js"></script>
</head>

<body id="body">

  <header>
    <div class="column">
      <img id="pictureUrl" width="100" height="100">
    </div>
    <div class="column">
      <p id="userId"></p>
      <h1>
        <p id="displayName"></p>
      </h1>
      <p id="statusMessage"></p>
    </div>
  </header>
  <main>
    <section>
      <select id="pageSelector" onchange="goToSelectedPage()">
        <option value="page1">ตรวจที่เกิดเหตุ</option>
        <option value="page2">กำลังปรับปรุง</option>
        <option value="page3">San APP</option>
      </select>
      <button id="btnLogin" onclick="liff.login()">Log In</button>
      <button id="btnLogOut" onclick="logOut()">Log Out</button>
      <button id="btnLogOut" onclick="settext()">เช็ค</button>
    </section>

    <section id="textbox">
      <div class="input-box">
      <form id="mainform">
        <div id="display_error" style="color: red"></div>
        <label for="datetime">วันที่:</label>
        <input type="date" id="datetime">
        <!--================================================ผู้ปฏิบัติ===============================================-->
        <label for="user">ผู้ปฏิบัติ:</label>
        <input list="userlist" id="user">
        <datalist id="userlist">
          <option value="ชุดสืบสวน">
          <option value="พัฒนา">
          <option value="สายตรวจเขต">
          <option value="สายตรวจตู้ยาม">
        </datalist>
        <!--==================================================ช่องรายละเอียด============================================-->
        <label for="deail">รายละเอียด:</label>
        <textarea id="detail" cols="100" rows="5"></textarea>
        <!--=============================================ช่องพิกัด=====================================================-->
        <label for="latlong">พิกัด:</label>
        <input type="text" id="latlong">
      </form>
      </div>

      <button id="btnsend">ส่งข้อความ</button>
      <button id="btnflex">ส่ง Flex</button>
      <button id="btnShare">แชร์</button>
    </section>

  </main>

  <footer>
    <h2>พัฒนาโดย San Kunakorn <br> งานสืบสวน สภ.นิคมพัฒนา ภ.จว.ระยอง</h2>
  </footer>



  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("btnsend").addEventListener("click", sendMessage)
      document.getElementById("btnShare").addEventListener("click", sendShare)
      document.getElementById("btnflex").addEventListener("click", sendFlex)
    });

    function settext() {
      let user = document.getElementById("user").value;
      let datetimeInput = document.getElementById("datetime");
      let datetime = datetimeInput.value ? new Date(datetimeInput.value) : new Date(); // Check if datetime input is empty, if yes, use current date
      let detail = document.getElementById("detail").value;
      let latlong = document.getElementById("latlong").value;
      // Options for Thai locale
      let options = { year: 'numeric', month: 'short', day: 'numeric' };
      // Convert the date to Thai locale
      let thaiDate = datetime.toLocaleDateString('th-TH', options);

      let message = 'เรียน ผู้บังคับบัญชา' + "\n-------------------------" + '\n     วันนี้( ' + thaiDate + ' )' + "\n" + user + ' ' + detail + "\n แผนที่: https://maps.google.com?q=" + latlong + '\n   ' + "     จึงเรียนมาเพื่อโปรดทราบ";

      alert(`${message}`)


      return message;
    }

    // Function to navigate to selected page
    function goToSelectedPage() {
      // Get the selected page value
      var selectedPage = document.getElementById("pageSelector").value;
      // Determine the URL based on the selected page value
      switch (selectedPage) {
        case "page1":
          document.getElementById("textbox").style.display = "block";
          break;
        case "page2":
          document.getElementById("textbox").style.display = "none";
          break;
        case "page3":
          window.location.href = 'https://san-all.web.app';
          break;
        default:
          document.getElementById("tel").style.display = "block";
          break;
      }
    }
  </script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

  <script>

    async function sendShare() {

      /*var detail = document.getElementById('detail').value;
        var datetime = document.getElementById('datetime').value;
        var user = document.getElementById('user').value;
        var latlong = document.getElementById('latlong').value;
        var message = 'เรียน ผู้บังคับบัญชา\n     วันนี้(' + datetime + ')\n' + user + ' ' + detail + '\n' + latlong;
        */

      var message = await settext();


      const result = await liff.shareTargetPicker([
        {
          type: "text",
          text: message,// ข้อความที่ต้องการแชร์
        },
        // สามารถเพิ่มประเภทอื่น ๆ และข้อมูลเพิ่มเติมตามต้องการ
      ])

      if (result) {
        alert(`[${result.status}] Message sent!`)
        document.getElementById("mainform").reset()

      } else {
        const [majorVer, minorVer, patchVer] = (liff.getLineVersion() || "").split('.');

        if (minorVer === undefined) {
          alert('ShareTargetPicker was canceled in external browser')
          return
        }

        if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
          alert('ShareTargetPicker was canceled in LINE app')
        }
      }
    }


    async function sendMessage() {

      /* var detail = document.getElementById('detail').value;
       var datetime = document.getElementById('datetime').value;
       var user = document.getElementById('user').value;
       var latlong = document.getElementById('latlong').value;
       var message = 'เรียน ผู้บังคับบัญชา\n     วันนี้(' + datetime + ')\n' + user + ' ' + detail + '\n' + latlong;
       */
      var message = await settext();
      try {
        // เรียกใช้ LIFF API เพื่อส่งข้อความ
        await liff.sendMessages([
          {
            type: 'text',
            text: message, // ข้อความที่ต้องการส่ง
          }
          // สามารถเพิ่มประเภทของข้อความและข้อมูลเพิ่มเติมตามต้องการ
        ]);

        alert("Message sent successfully!");
        document.getElementById("mainform").reset()
      } catch (error) {
        alert("Error occurred while trying to send message:", error);
      }
    }


    async function sendFlex() {
      //var message = await settext();
       var detail = document.getElementById('detail').value;
       var datetime = document.getElementById('datetime').value;
       var user = document.getElementById('user').value;
       var latlong = document.getElementById('latlong').value;
      try {
        // เรียกใช้ LIFF API เพื่อส่งข้อความ
        await liff.sendMessages([
          {
            "type": "flex",
            "altText": "ผลการตรวจสอบ",
            "contents": {

              "type": "bubble",
              "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "ผลการค้นหา",
                    "weight": "bold",
                    "size": "xl",
                    "align": "center"
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "icon",
                        "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png"
                      },
                      {
                        "type": "text",
                        "text": user,
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5
                      }
                    ]
                  }
                ]
              },
              "body": {
                "type": "box",
                "layout": "vertical",
                "margin": "lg",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "Results",
                        "color": "#aaaaaa",
                        "size": "sm",
                        "flex": 1
                      },
                      {
                        "type": "text",
                        "text": detail,//ผล
                        "wrap": true,
                        "color": "#666666",
                        "size": "sm",
                        "flex": 5
                      }
                    ]
                  },
                  {
                    "type": "separator"
                  }
                ]
              },
              "footer": {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "button",
                    "style": "link",
                    "height": "sm",
                    "action": {
                      "type": "uri",
                      "label": "แผนที่",
                      "uri": "https://maps.google.com?q=" + latlong,
                    }
                  },
                  {
                    "type": "separator"
                  },
                  {
                    "type": "text",
                    "text": "SAN BOT —> San K.",
                    "align": "end"
                  },
                  {
                    "type": "button",
                    "style": "secondary",
                    "height": "sm",
                    "action": {
                      "type": "uri",
                      "label": "Line",
                      "uri": "http://line.me/ti/p/~@223zypdp"
                    },
                    "color": "#00FF66"
                  },
                ],
                "flex": 0
              },
              "styles": {
                "header": {
                  "backgroundColor": "#99FFFF"
                }
              }
            }
          }
        ]);


        alert("Message sent successfully!");
        document.getElementById("mainform").reset()
      } catch (error) {
        alert("Error occurred while trying to send message:", error);
      }
    }




    function logOut() {
      liff.logout()
      window.location.reload()
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        const pictureUrl = document.getElementById("pictureUrl");
        const userId = document.getElementById("userId");
        const displayName = document.getElementById("displayName");
        const statusMessage = document.getElementById("statusMessage");
        pictureUrl.src = profile.pictureUrl;
        //userId.innerHTML = "<b>userId:</b> " + profile.userId;
        displayName.innerHTML = profile.displayName + " <b>Login</b> ";
        //statusMessage.innerHTML = "<b>statusMessage:</b> " + profile.statusMessage;
      } catch (error) {
        console.error("Error occurred while trying to get user profile:", error);
      }
    }

    async function main() {
      liff.ready.then(() => {
        if (liff.getOS() === "android") {
          body.style.backgroundColor = "#88888"
        }
        if (liff.isInClient()) {
          getUserProfile()
        }
      })
      await liff.init({ liffId: "2004593216-XbA9wj26" })
      if (liff.isLoggedIn()) {
        document.getElementById("btnShare").style.display = "block"
        document.getElementById("btnLogin").style.display = "none"
        if (!liff.isInClient()) {
          document.getElementById("btnLogOut").style.display = "block"
        }
      } else {
        //liff.login()
        document.getElementById("btnLogin").style.display = "block"
      }
    }
    main()
  </script>

</body>

</html>